<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniMax + Invisible Watermark</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f11;--surface:#18181b;--surface2:#27272a;--border:#3f3f46;
  --text:#fafafa;--text2:#a1a1aa;--accent:#6366f1;--accent2:#818cf8;
  --green:#22c55e;--red:#ef4444;--orange:#f59e0b;
  --radius:10px;--font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
}
html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text)}
a{color:var(--accent2)}

.app{display:grid;grid-template-columns:1fr 400px;height:100vh}
@media(max-width:960px){.app{grid-template-columns:1fr;grid-template-rows:1fr auto}}

.chat-panel{display:flex;flex-direction:column;border-right:1px solid var(--border)}
.chat-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.chat-header h1{font-size:16px;font-weight:600;white-space:nowrap}
.chat-header select,.chat-header input[type=number]{
  background:var(--surface2);color:var(--text);border:1px solid var(--border);
  padding:6px 10px;border-radius:6px;font-size:13px}
.chat-header label{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px}

.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.msg{max-width:85%;padding:12px 16px;border-radius:var(--radius);font-size:14px;line-height:1.6;white-space:pre-wrap;word-break:break-word}
.msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:2px}
.msg.assistant{align-self:flex-start;background:var(--surface2);border-bottom-left-radius:2px}
.msg.thinking{align-self:flex-start;background:var(--surface);border:1px dashed var(--border);color:var(--text2);font-size:13px}
.msg.error{align-self:center;background:var(--red);color:#fff;font-size:13px}
.msg-label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:4px}

.chat-input-area{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px}
.chat-input-area textarea{
  flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border);
  border-radius:var(--radius);padding:10px 14px;font-size:14px;resize:none;
  font-family:var(--font);min-height:44px;max-height:120px}
.chat-input-area textarea:focus{outline:none;border-color:var(--accent)}
.chat-input-area textarea::placeholder{color:var(--text2)}
.btn{
  background:var(--accent);color:#fff;border:none;padding:10px 20px;
  border-radius:var(--radius);font-size:13px;font-weight:600;cursor:pointer;
  white-space:nowrap;transition:background .15s}
.btn:hover{background:var(--accent2)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:var(--surface2);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--border)}

.side-panel{display:flex;flex-direction:column;overflow-y:auto;background:var(--surface)}
.side-tabs{display:flex;border-bottom:1px solid var(--border)}
.side-tabs button{
  flex:1;background:none;border:none;color:var(--text2);padding:12px;
  font-size:13px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent}
.side-tabs button.active{color:var(--text);border-bottom-color:var(--accent)}
.tab-body{flex:1;padding:16px;overflow-y:auto}
.tab-body.hidden{display:none}

.field{margin-bottom:14px}
.field label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px}
.field textarea,.field input[type=text],.field input[type=number]{
  width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);
  border-radius:6px;padding:8px 10px;font-size:13px;font-family:var(--font)}
.field textarea{min-height:120px;resize:vertical}
.field textarea:focus,.field input:focus{outline:none;border-color:var(--accent)}

.result-box{
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px;margin-top:12px;font-size:13px;line-height:1.5}
.result-box .tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-right:6px}
.tag-yes{background:rgba(34,197,94,.15);color:var(--green)}
.tag-no{background:rgba(239,68,68,.15);color:var(--red)}
.tag-info{background:rgba(99,102,241,.15);color:var(--accent2)}

.payload-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:6px;
  padding:10px 12px;margin-top:8px;font-size:12px;font-family:'SF Mono',monospace}
.payload-card div{margin-bottom:2px}
.payload-card .k{color:var(--text2)}
.payload-card .v{color:var(--text)}

.system-prompt-area{padding:12px 20px;border-bottom:1px solid var(--border)}
.system-prompt-area textarea{
  width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);
  border-radius:6px;padding:8px 10px;font-size:12px;font-family:var(--font);
  resize:vertical;min-height:36px;max-height:80px}
.system-prompt-area label{font-size:11px;color:var(--text2);margin-bottom:4px;display:block}

.toggle{position:relative;width:40px;height:22px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{
  position:absolute;inset:0;background:var(--surface2);border:1px solid var(--border);
  border-radius:11px;transition:.2s}
.toggle .slider::before{
  content:'';position:absolute;left:2px;top:2px;width:16px;height:16px;
  background:var(--text2);border-radius:50%;transition:.2s}
.toggle input:checked+.slider{background:var(--accent);border-color:var(--accent)}
.toggle input:checked+.slider::before{transform:translateX(18px);background:#fff}

.wm-badge{
  display:inline-flex;align-items:center;gap:4px;padding:2px 8px;
  border-radius:4px;font-size:10px;font-weight:600;margin-left:8px}
.wm-badge.on{background:rgba(34,197,94,.15);color:var(--green)}
.wm-badge.off{background:rgba(239,68,68,.15);color:var(--red)}

.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="app">
  <div class="chat-panel">
    <div class="chat-header">
      <h1>MiniMax Watermark Lab</h1>
      <select id="model"></select>
      <label>
        Watermark
        <span class="toggle"><input type="checkbox" id="wm-toggle" checked><span class="slider"></span></span>
      </label>
      <label>Temp <input type="number" id="temp" value="0.7" min="0.01" max="1" step="0.05" style="width:60px"></label>
      <label>Max tokens <input type="number" id="max-tokens" value="2048" min="1" max="16384" step="256" style="width:80px"></label>
      <button class="btn btn-secondary" onclick="clearChat()" style="padding:6px 12px">Clear</button>
    </div>
    <div class="system-prompt-area">
      <label>System prompt</label>
      <textarea id="system-prompt" rows="1">You are a helpful assistant.</textarea>
    </div>
    <div class="messages" id="messages"></div>
    <div class="chat-input-area">
      <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
      <button class="btn" id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div class="side-panel">
    <div class="side-tabs">
      <button class="active" onclick="switchTab('detect',this)">Detect</button>
      <button onclick="switchTab('apply',this)">Apply</button>
      <button onclick="switchTab('strip',this)">Strip</button>
      <button onclick="switchTab('settings',this)">Settings</button>
    </div>

    <div class="tab-body" id="tab-detect">
      <div class="field">
        <label>Paste text to scan for watermarks</label>
        <textarea id="detect-input" placeholder="Paste watermarked text here..."></textarea>
      </div>
      <button class="btn" onclick="runDetect()">Detect Watermark</button>
      <button class="btn btn-secondary" onclick="copyLastResponse()" style="margin-left:6px">Copy last response</button>
      <div id="detect-result"></div>
    </div>

    <div class="tab-body hidden" id="tab-apply">
      <div class="field">
        <label>Plain text to watermark</label>
        <textarea id="apply-input" placeholder="Enter text to watermark..."></textarea>
      </div>
      <button class="btn" onclick="runApply()">Apply Watermark</button>
      <div id="apply-result"></div>
    </div>

    <div class="tab-body hidden" id="tab-strip">
      <div class="field">
        <label>Watermarked text to clean</label>
        <textarea id="strip-input" placeholder="Paste watermarked text..."></textarea>
      </div>
      <button class="btn" onclick="runStrip()">Strip Watermark</button>
      <div id="strip-result"></div>
    </div>

    <div class="tab-body hidden" id="tab-settings">
      <h3 style="font-size:14px;margin-bottom:12px">Watermark Metadata</h3>
      <div class="field"><label>Issuer ID (0-4095)</label><input type="number" id="wm-issuer" value="1" min="0" max="4095"></div>
      <div class="field"><label>Model ID (0-65535)</label><input type="number" id="wm-model" value="0" min="0" max="65535"></div>
      <div class="field"><label>Model Version ID (0-65535)</label><input type="number" id="wm-version" value="0" min="0" max="65535"></div>
      <div class="field"><label>Key ID (0-255)</label><input type="number" id="wm-key" value="1" min="0" max="255"></div>
      <div class="field"><label>Repeat interval (tokens)</label><input type="number" id="wm-interval" value="160" min="1" max="10000"></div>
      <div class="result-box" style="margin-top:16px">
        <div style="font-size:11px;color:var(--text2);margin-bottom:6px">ZERO-WIDTH CHAR MAP</div>
        <div style="font-size:12px;line-height:1.8">
          <code>0</code> &rarr; U+200B (ZWSP)<br>
          <code>1</code> &rarr; U+200C (ZWNJ)<br>
          <code>start</code> &rarr; U+2063 (INVISIBLE SEPARATOR)<br>
          <code>end</code> &rarr; U+2064 (INVISIBLE PLUS)<br>
          <strong>Tag size:</strong> 66 chars (1 start + 64 payload + 1 end)
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const userInput = document.getElementById('user-input');
let conversationHistory = [];
let lastAssistantText = '';

(async function loadModels() {
  try {
    const resp = await fetch('/api/models');
    const data = await resp.json();
    const sel = document.getElementById('model');
    for (const m of data.models) {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      sel.appendChild(opt);
    }
  } catch(e) { console.error('Failed to load models', e); }
})();

function getWmParams() {
  return {
    issuer_id: +document.getElementById('wm-issuer').value,
    model_id: +document.getElementById('wm-model').value,
    model_version_id: +document.getElementById('wm-version').value,
    key_id: +document.getElementById('wm-key').value,
    repeat_interval_tokens: +document.getElementById('wm-interval').value,
  };
}

function addMessage(role, text, extra) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (extra) {
    const lbl = document.createElement('div');
    lbl.className = 'msg-label';
    lbl.textContent = extra;
    div.appendChild(lbl);
  }
  const content = document.createElement('span');
  content.textContent = text;
  div.appendChild(content);
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return content;
}

function clearChat() {
  conversationHistory = [];
  messagesEl.innerHTML = '';
  lastAssistantText = '';
}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;
  userInput.value = '';

  addMessage('user', text);
  conversationHistory.push({ role: 'user', content: [{ type: 'text', text }] });

  const sendBtn = document.getElementById('send-btn');
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span class="spinner"></span>...';

  const model = document.getElementById('model').value;
  const watermark = document.getElementById('wm-toggle').checked;
  const temperature = +document.getElementById('temp').value;
  const max_tokens = +document.getElementById('max-tokens').value;
  const system = document.getElementById('system-prompt').value;

  try {
    const resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model, messages: conversationHistory, system,
        watermark, wm_params: getWmParams(),
        stream: false, max_tokens, temperature,
      }),
    });
    const data = await resp.json();
    if (data.error) {
      addMessage('error', data.error);
    } else {
      if (data.thinking) addMessage('thinking', data.thinking, 'Thinking');
      const badge = watermark ? '<span class="wm-badge on">WM</span>' : '<span class="wm-badge off">RAW</span>';
      const el = addMessage('assistant', data.text, '');
      el.parentElement.querySelector('.msg-label')?.remove();
      const lbl = document.createElement('div');
      lbl.className = 'msg-label';
      lbl.innerHTML = model + badge;
      el.parentElement.insertBefore(lbl, el);

      lastAssistantText = data.text;
      conversationHistory.push({ role: 'assistant', content: [{ type: 'text', text: data.text }] });
    }
  } catch (e) {
    addMessage('error', 'Network error: ' + e.message);
  }

  sendBtn.disabled = false;
  sendBtn.textContent = 'Send';
}

userInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

function switchTab(id, btn) {
  document.querySelectorAll('.tab-body').forEach(t => t.classList.add('hidden'));
  document.getElementById('tab-' + id).classList.remove('hidden');
  document.querySelectorAll('.side-tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function copyLastResponse() {
  if (lastAssistantText) {
    document.getElementById('detect-input').value = lastAssistantText;
  }
}

async function runDetect() {
  const text = document.getElementById('detect-input').value;
  if (!text) return;
  const resp = await fetch('/api/detect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, wm_params: getWmParams() }),
  });
  const data = await resp.json();
  let html = '<div class="result-box">';
  if (data.watermarked) {
    html += '<span class="tag tag-yes">WATERMARKED</span>';
  } else {
    html += '<span class="tag tag-no">NOT DETECTED</span>';
  }
  html += `<span class="tag tag-info">${data.valid_count} valid / ${data.tag_count} tags</span>`;
  if (data.payloads && data.payloads.length > 0) {
    for (const p of data.payloads) {
      html += `<div class="payload-card">
        <div><span class="k">schema_version:</span> <span class="v">${p.schema_version}</span></div>
        <div><span class="k">issuer_id:</span> <span class="v">${p.issuer_id}</span></div>
        <div><span class="k">model_id:</span> <span class="v">${p.model_id}</span></div>
        <div><span class="k">model_version_id:</span> <span class="v">${p.model_version_id}</span></div>
        <div><span class="k">key_id:</span> <span class="v">${p.key_id}</span></div>
        <div><span class="k">crc_valid:</span> <span class="v">${p.crc_valid ? '\u2713' : '\u2717'}</span></div>
        <div><span class="k">raw_payload:</span> <span class="v">${p.raw_payload_hex}</span></div>
      </div>`;
    }
  }
  html += '</div>';
  document.getElementById('detect-result').innerHTML = html;
}

async function runApply() {
  const text = document.getElementById('apply-input').value;
  if (!text) return;
  const resp = await fetch('/api/apply', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, wm_params: getWmParams() }),
  });
  const data = await resp.json();
  const charCount = (data.text.length - data.raw_text.length);
  document.getElementById('apply-result').innerHTML = `
    <div class="result-box">
      <span class="tag tag-yes">WATERMARKED</span>
      <span class="tag tag-info">${charCount} invisible chars added</span>
      <div style="margin-top:10px">
        <label style="font-size:11px;color:var(--text2)">Result (copy this):</label>
        <textarea readonly style="width:100%;min-height:80px;margin-top:4px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px">${escapeHtml(data.text)}</textarea>
      </div>
    </div>`;
}

async function runStrip() {
  const text = document.getElementById('strip-input').value;
  if (!text) return;
  const resp = await fetch('/api/strip', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text }),
  });
  const data = await resp.json();
  const removed = text.length - data.text.length;
  document.getElementById('strip-result').innerHTML = `
    <div class="result-box">
      <span class="tag tag-info">${removed} invisible chars removed</span>
      <div style="margin-top:10px">
        <label style="font-size:11px;color:var(--text2)">Clean text:</label>
        <textarea readonly style="width:100%;min-height:80px;margin-top:4px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px">${escapeHtml(data.text)}</textarea>
      </div>
    </div>`;
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
